/*! 2015 Baidu Inc. All Rights Reserved */
define("common/widget/Waterfall",["require","zepto","common/lib/env"],function(require){function e(){this.lis=null,this.pages=1,this.imgWidth=0,this.flag=!1,this.loading=null,this.ajaxUrl="",this.container=null,this.done=!1}var t=require("zepto"),n=require("common/lib/env");return e.prototype.init=function(e){this.lis=t("#"+e.idName+" li"),this.ajaxUrl=e.ajaxUrl,this.imgWidth=this.lis.eq(0).width(),this.listenScroll(),this.loading=t("#"+e.idName+" .waterfall-loading"),this.loading.css("display","block"),this.container=t("#"+e.containerId)},e.prototype.listenScroll=function(){function e(){var r=n.getShortLi(),i=n.lis.eq(r);if(t(window).scrollTop()+t(window).height()>i.height()+i.offset().top){if(n.flag===!0)n.flag=!1,n.pages++,n.getImages();if(n.done===!0)t(window).off("scroll",e)}}var n=this;t(window).on("scroll",e)},e.prototype.getImages=function(){var e=this;this.loading.css("display","block");var r=t.ajax({type:"GET",data:{page:e.pages},url:e.ajaxUrl,dataType:"json",success:function(r){var i=r.data;if(0===i.length)this.done=!0;else for(var o=0;o<i.length;o++){var s=e.getShortLi(),a=t("<img />");a.attr("src",i[o].thumbUrl);var l=t("<a></a>");l.attr("href",i[o].objUrl),l.attr("target","_blank"),l.append(a);{i[o].objUrl}if(n.os.ios)l.on("click",function(n){n.preventDefault();var r=t("<iframe></iframe>");r.css("width","100%"),r.css("height","100%"),r.attr("src",t(this).attr("href")),r.css("frameborder","0");var i=t("<div></div>");i.addClass("iframe-wrapper"),i.append(r),t(document.body).append(i),e.container.hide();var o=t(document.body).scrollTop(),s=t(this).attr("href").match(/http\:\/\/[\w\-\.\:]*([\/\-\w]*)/)[1];history.pushState({},"相似图",s),window.onpopstate=function(){i.remove(),e.container.show(),t(document.body).scrollTop(o)}});var u=t("<div></div>");u.addClass("waterfall-img"),u.css({height:Math.ceil(i[o].thumbHeight*e.imgWidth/i[o].thumbWidth)}),u.append(l),e.lis.eq(s).append(u)}e.loading.css("display","none"),e.flag=!0},error:function(){}});return r},e.prototype.getShortLi=function(){for(var e=Number.MAX_VALUE,t=-1,n=0;n<this.lis.size();n++){var r=this.lis.eq(n).height();if(e>r)e=r,t=n}return t},e});