/*! 2015 Baidu Inc. All Rights Reserved */
define("common/widget/Waterfall",["require","zepto","common/lib/env"],function(require){function e(){this.lis=null,this.pages=1,this.imgWidth=0,this.flag=!1,this.loading=null,this.ajaxUrl="",this.container=null,this.done=!1}var t=require("zepto"),n=require("common/lib/env");return e.prototype.init=function(e){this.lis=t("#"+e.idName+" li"),this.ajaxUrl=e.ajaxUrl,this.imgWidth=this.lis.eq(0).width(),this.listenScroll(),this.loading=t("#"+e.idName+" .waterfall-loading"),this.loading.css("display","block"),this.container=t("#"+e.containerId)},e.prototype.listenScroll=function(){function e(r){var i=n.getShortLi(),o=n.lis.eq(i);if(t(window).scrollTop()+t(window).height()>o.height()+o.offset().top){if(n.flag===!0)n.flag=!1,n.pages++,n.getImages();if(n.done===!0)t(window).off("scroll",e)}}var n=this;t(window).on("scroll",e)},e.prototype.getImages=function(){var e=this;this.loading.css("display","block"),t.ajax({type:"GET",data:{page:e.pages},url:e.ajaxUrl,dataType:"json",success:function(r){alert(r);var i=r.data;if(0===i.length)this.done=!0;else for(var o=0;o<i.length;o++){var a=e.getShortLi(),s=t("<img />");s.attr("src",i[o].thumbUrl);var c=t("<a></a>");c.attr("href",i[o].objUrl),c.attr("target","_blank"),c.append(s);i[o].objUrl;if(n.os.ios)c.on("click",function(n){n.preventDefault();var r=t("<iframe></iframe>");r.css("width","100%"),r.css("height","100%"),r.attr("src",t(this).attr("href")),r.css("frameborder","0");var i=t("<div></div>");i.addClass("iframe-wrapper"),i.append(r),t(document.body).append(i),e.container.hide();var o=t(document.body).scrollTop(),a=t(this).attr("href").match(/http\:\/\/[\w\-\.\:]*([\/\-\w]*)/)[1];history.pushState({},"相似图",a),window.onpopstate=function(n){i.remove(),e.container.show(),t(document.body).scrollTop(o)}});var l=t("<div></div>");l.addClass("waterfall-img"),l.css({height:Math.ceil(i[o].imageHeight*e.imgWidth/i[o].imageWidth)}),l.append(c),e.lis.eq(a).append(l)}e.loading.css("display","none"),e.flag=!0},error:function(){}})},e.prototype.getShortLi=function(){for(var e=Number.MAX_VALUE,t=-1,n=0;n<this.lis.size();n++){var r=this.lis.eq(n).height();if(e>r)e=r,t=n}return t},e});