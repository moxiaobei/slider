/*! 2015 Baidu Inc. All Rights Reserved */
define("common/widget/slider/slider",["require","zepto","common/lib/utils","common/widget/toast/toast"],function(require){function e(e){return'<div class="slider-pic"><div class="slider-pic_view" style="background-image: url('+e.src+')"><img src="'+e.src+'"></div></div>'}var t,n=require("zepto"),r=require("common/lib/utils"),i=require("common/widget/toast/toast"),o=['<div class="slider">','<div class="slider-container">','<a class="slider-head" href="#" target="_blank">','<div class="slider-title"></div>','<div class="slider-link"></div>',"</a>",'<div class="slider-pics"></div>','<div class="slider-button">','<button type="button" class="slider-pic_search_btn" data-url="">识别此图</button>',"</div>",'<div class="slider-toast"><div class="slider-cycle"></div>识别中...</div>',"</div>","</div>"].join("");if(window.navigator.pointerEnabled)t=["pointerdown","pointermove","pointerup","pointercancel"];else if(window.navigator.msPointerEnabled)t=["MSPointerDown","MSPointerMove","MSPointerUp","MSPointerCancel"];else if("ontouchstart"in window)t=["touchstart","touchmove","touchend","touchcancel"];else t=["mousedown","mousemove","mouseup","mouseout"];if(!t){var s=function(){};return{start:s,end:s,move:s,cancel:s,clear:s}}var a=t[0],l=t[1],c=t[2],u=t[3];window.addEventListener("hashchange",function(){var e=location.hash.replace("#","");if("imgView"!==e)d&&d.hide()},!1);var f=function(){var e=n(window),t=document.createElement("div");t.innerHTML=o,t.style.cssText="position:absolute;left:0;right:0;top:0;display:none;overflow:hidden;",t.style.height=e.height()+"px",e.on("resize",function(){t.style.height=e.height()+"px"}),document.body.appendChild(t);var r=this;r.el=t,r.imgList=[],r.showTitle=!0,r.currNum=0,r.loading=!1,r.isAbort=!1,r.container=t.querySelector(".slider-container"),r.head=t.querySelector(".slider-head"),r.title=t.querySelector(".slider-title"),r.link=t.querySelector(".slider-link"),r.pics=t.querySelector(".slider-pics"),r.btn=t.querySelector(".slider-pic_search_btn"),r.otherEl=[],r.scrollTop=0;{var s=r.pics,f=!1,d=!1;n(s)}s.addEventListener("click",function(){history.back()}),s.addEventListener(a,function(e){if(e.touches=e.touches||[],1===e.touches.length){var t=e.touches[0];d=[t.clientX,t.clientY],f=!0}else f=!1;s.addEventListener(l,function(e){if(e.touches=e.touches||[],1!==e.touches.length)return void(f=!1);if(f&&d){e.preventDefault();var t=e.touches[0],n=[t.clientX,t.clientY],i=n[0]-d[0];if(-50>i)r.next(),f=!1;if(i>50)r.prev(),f=!1}}),s.addEventListener(c,function(){f=!1,d=!1}),s.addEventListener(u,function(){f=!1,d=!1})}),r.btn.addEventListener("click",function(e){if(e.preventDefault(),r.loading)r.isAbort=!0,r.loading.abort(),r.loading=!1,n(r.el).removeClass("slider-loading"),r.btn.innerHTML="识别此图";else{r.isAbort=!1;var t=n(r.btn).data("url");if(!t)return;n(r.el).addClass("slider-loading"),r.btn.innerHTML="取消",r.loading=n.ajax({type:"GET",url:"/ir",data:{url:t},dataType:"json",timeout:1e4,success:function(e){var t=e.data;if(n(r.el).removeClass("slider-loading"),r.btn.innerHTML="识别此图",r.loading=!1,t.url)location.href=t.url;else i.makeText("服务器开小差了，请稍候重试")},error:function(e,t){if(r.loading=!1,"abort"!==t&&!r.isAbort)i.makeText("服务器开小差了，请稍候重试");r.isAbort=!1,n(r.el).removeClass("slider-loading"),r.btn.innerHTML="识别此图"}})}})};f.prototype.show=function(e){var t,r,i=this;if(0!==i.imgList.length){for(location.hash="#imgView",this.scrollTop=window.scrollY,this.otherEl=[].slice.call(document.querySelectorAll(".global_container")),t=0,r=this.otherEl.length;r>t;t++)this.otherEl[t].style.display="none";if(!this.showTitle)this.el.className="slider-no_head";else this.el.className="";setTimeout(function(){if(i.el.style.display="block",!e)return void i._order(0);var o=n(e).data("src");if(o)for(t=0,r=i.imgList.length;r>t;t++){var s=i.imgList[t];if(s.src===o)return void i._order(t)}},100)}},f.prototype.hide=function(){for(var e=this,t=0,n=this.otherEl.length;n>t;t++)this.otherEl[t].style.display="block";setTimeout(function(){e.el.style.display="none",window.scrollTo(0,e.scrollTop),e.empty()},100)},f.prototype._order=function(e){if(!(0>e||e>=this.imgList.length)){var t,n,r,o=this.imgList[e],s=this.imgList.length,a=this.pics.querySelectorAll(".slider-pic");if(a.length!==s)return void i.makeText("出错了，请刷新当前页面");for(t=0,n=a.length;n>t;t++)if(!(t>=e-2&&e+2>=t))r=a[t],r.className="slider-pic";else;a[e].className="slider-pic slider-pic-current",e-1>=0&&(a[e-1].className="slider-pic slider-pic-left"),e-2>=0&&(a[e-2].className="slider-pic slider-pic-prev"),s>e+1&&(a[e+1].className="slider-pic slider-pic-right"),s>e+2&&(a[e+2].className="slider-pic slider-pic-next"),this._setHead(o.title,o.link),this._setUrl(o.src),this.currNum=e}},f.prototype._setHead=function(e,t){this.title.innerHTML=e,this.link.innerHTML=t,this.head.href=r.redirect(t,!0)},f.prototype._setUrl=function(e){n(this.btn).data("url",e)},f.prototype.next=function(){this._order(this.currNum+1)},f.prototype.prev=function(){this._order(this.currNum-1)},f.prototype.fetchList=function(t){var r=n(t).data("relative"),i=document.getElementsByClassName(r);if(this.showTitle=!0,n(t).data("src")){for(var o="",s=0,a=i.length;a>s;s++){var l=i[s],c=!1,u=!1,f=n(l).data("src");if(f){if(this.showTitle)if(c=n(l).data("title"),u=n(l).data("link"),!c||!u)this.showTitle=!1;var d={title:c,link:u,src:f};this.imgList.push(d),o+=e(d)}else;}n(this.pics).append(o)}},f.prototype.empty=function(){this.imgList.length=0,this.pics.innerHTML=""};var d=new f;return d});