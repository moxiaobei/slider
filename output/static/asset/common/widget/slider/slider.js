/*! 2015 Baidu Inc. All Rights Reserved */
define("common/widget/slider/slider",["require","zepto","common/lib/utils","common/widget/toast/toast"],function(require){function e(e){return'<div class="slider-pic"><div class="slider-pic_view" style="background-image: url('+e.src+')"><img src="'+e.src+'"></div></div>'}var t,n=require("zepto"),r=require("common/lib/utils"),i=require("common/widget/toast/toast"),o=['<div class="slider">','<div class="slider-container">','<a class="slider-head" href="#" target="_blank">','<div class="slider-title"></div>','<div class="slider-link"></div>',"</a>",'<div class="slider-pics"></div>','<div class="slider-button">','<button type="button" class="slider-pic_search_btn" data-url="">识别此图</button>',"</div>",'<div class="slider-toast"><div class="slider-cycle"></div>识别中...</div>',"</div>","</div>"].join("");if(window.navigator.pointerEnabled)t=["pointerdown","pointermove","pointerup","pointercancel"];else if(window.navigator.msPointerEnabled)t=["MSPointerDown","MSPointerMove","MSPointerUp","MSPointerCancel"];else if("ontouchstart"in window)t=["touchstart","touchmove","touchend","touchcancel"];else t=["mousedown","mousemove","mouseup","mouseout"];if(!t){var a=function(){};return{start:a,end:a,move:a,cancel:a,clear:a}}var s=t[0],c=t[1],l=t[2],u=t[3];window.addEventListener("hashchange",function(){var e=location.hash.replace("#","");if("imgView"!==e)f&&f.hide()},!1);var d=function(){var e=n(window),t=document.createElement("div");t.innerHTML=o,t.style.cssText="position:absolute;left:0;right:0;top:0;display:none;overflow:hidden;",t.style.height=e.height()+"px",e.on("resize",function(){t.style.height=e.height()+"px"}),document.body.appendChild(t);var r=this;r.el=t,r.imgList=[],r.showTitle=!0,r.currNum=0,r.loading=!1,r.isAbort=!1,r.container=t.querySelector(".slider-container"),r.head=t.querySelector(".slider-head"),r.title=t.querySelector(".slider-title"),r.link=t.querySelector(".slider-link"),r.pics=t.querySelector(".slider-pics"),r.btn=t.querySelector(".slider-pic_search_btn"),r.otherEl=[],r.scrollTop=0;var a=r.pics,d=!1,f=!1;n(a);a.addEventListener("click",function(e){history.back()}),a.addEventListener(s,function(e){if(e.touches=e.touches||[],1===e.touches.length){var t=e.touches[0];f=[t.clientX,t.clientY],d=!0}else d=!1;a.addEventListener(c,function(e){if(e.touches=e.touches||[],1!==e.touches.length)return void(d=!1);if(d&&f){e.preventDefault();var t=e.touches[0],n=[t.clientX,t.clientY],i=n[0]-f[0];if(-50>i)r.next(),d=!1;if(i>50)r.prev(),d=!1}}),a.addEventListener(l,function(e){d=!1,f=!1}),a.addEventListener(u,function(e){d=!1,f=!1})}),r.btn.addEventListener("click",function(e){if(e.preventDefault(),r.loading)r.isAbort=!0,r.loading.abort(),r.loading=!1,n(r.el).removeClass("slider-loading"),r.btn.innerHTML="识别此图";else{r.isAbort=!1;var t=n(r.btn).data("url");if(!t)return;n(r.el).addClass("slider-loading"),r.btn.innerHTML="取消",r.loading=n.ajax({type:"POST",url:"/bdbox/ir/url",data:{url:t},dataType:"json",timeout:1e4,success:function(e,t,o){var a=e.response_params||{};if(n(r.el).removeClass("slider-loading"),r.btn.innerHTML="识别此图",r.loading=!1,a.returl)location.href=a.returl;else i.makeText("服务器开小差了，请稍候重试")},error:function(e,t,o){if(r.loading=!1,"abort"!==t&&!r.isAbort)i.makeText("服务器开小差了，请稍候重试");r.isAbort=!1,n(r.el).removeClass("slider-loading"),r.btn.innerHTML="识别此图"}})}})};d.prototype.show=function(e){var t,r,i=this;if(0!==i.imgList.length){for(location.hash="#imgView",this.scrollTop=window.scrollY,this.otherEl=[].slice.call(document.querySelectorAll(".global_container")),t=0,r=this.otherEl.length;r>t;t++)this.otherEl[t].style.display="none";if(!this.showTitle)this.el.className="slider-no_head";else this.el.className="";setTimeout(function(){if(i.el.style.display="block",!e)return void i._order(0);var o=n(e).data("src");if(o)for(t=0,r=i.imgList.length;r>t;t++){var a=i.imgList[t];if(a.src===o)return void i._order(t)}},100)}},d.prototype.hide=function(){for(var e=this,t=0,n=this.otherEl.length;n>t;t++)this.otherEl[t].style.display="block";setTimeout(function(){e.el.style.display="none",window.scrollTo(0,e.scrollTop),e.empty()},100)},d.prototype._order=function(e){if(!(0>e||e>=this.imgList.length)){var t,n,r,o=this.imgList[e],a=this.imgList.length,s=this.pics.querySelectorAll(".slider-pic");if(s.length!==a)return void i.makeText("出错了，请刷新当前页面");for(t=0,n=s.length;n>t;t++)if(!(t>=e-2&&e+2>=t))r=s[t],r.className="slider-pic";else;s[e].className="slider-pic slider-pic-current",e-1>=0&&(s[e-1].className="slider-pic slider-pic-left"),e-2>=0&&(s[e-2].className="slider-pic slider-pic-prev"),a>e+1&&(s[e+1].className="slider-pic slider-pic-right"),a>e+2&&(s[e+2].className="slider-pic slider-pic-next"),this._setHead(o.title,o.link),this._setUrl(o.src),this.currNum=e}},d.prototype._setHead=function(e,t){this.title.innerHTML=e,this.link.innerHTML=t,this.head.href=r.redirect(t,!0)},d.prototype._setUrl=function(e){n(this.btn).data("url",e)},d.prototype.next=function(){this._order(this.currNum+1)},d.prototype.prev=function(){this._order(this.currNum-1)},d.prototype.fetchList=function(t){var r=n(t).data("relative"),i=document.getElementsByClassName(r);if(this.showTitle=!0,n(t).data("src")){for(var o="",a=0,s=i.length;s>a;a++){var c=i[a],l=!1,u=!1,d=n(c).data("src");if(d){if(this.showTitle)if(l=n(c).data("title"),u=n(c).data("link"),!l||!u)this.showTitle=!1;var f={title:l,link:u,src:d};this.imgList.push(f),o+=e(f)}else;}n(this.pics).append(o)}},d.prototype.empty=function(){this.imgList.length=0,this.pics.innerHTML=""};var f=new d;return f});